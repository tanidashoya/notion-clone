//ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
//Supabase ã‚’ä½¿ã£ãŸã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ï¼‰å‡¦ç†
import { supabase } from "../../lib/supabase";


//å‘¼ã³å‡ºã—å…ƒã‹ã‚‰æ¸¡ã•ã‚ŒãŸ3ã¤ã®å€¤(name,email,password)ã‚’ä½¿ã†ã€‚
//Supabaseã®auth.signUp()ãƒ¡ã‚½ãƒƒãƒ‰ã«ãƒ¡ãƒ¼ãƒ«ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»åå‰ã‚’æ¸¡ã™ã€‚(ã“ã“ã§ã®signUPã¯supabase.auth.signUp() ã¯ 
// @supabase/supabase-js ã¨ã„ã†å…¬å¼ JavaScript ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«å«ã¾ã‚Œã¦ã„ã‚‹ èªè¨¼ç”¨ã®é–¢æ•°)
//çµæœãŒè¿”ã£ã¦ãã‚‹ã¨ã€data ã«æˆåŠŸæ™‚ã®æƒ…å ±ã€error ã«å¤±æ•—æ™‚ã®æƒ…å ±ãŒå…¥ã‚‹
//â€»authRepositoryã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆauthRepository ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®â€œä¸­ã«â€ signUp ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ï¼‰
//signUp() ã‚’å‘¼ã¶ã¨çµæœã¯å‘¼ã³å‡ºã—å…ƒã«è¿”ã‚‹ã ã‘ã§ã€authRepository è‡ªä½“ã¯ä½•ã‚‚è¦šãˆã¦ã„ãªã„ï¼ˆï¼ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ï¼‰


export const authRepository = {
    //signUp ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã¨ã€å†…éƒ¨ã§ supabase.auth.signUp() ãŒå®Ÿè¡Œã•ã‚Œã‚‹
    //supabase.auth.signUp() é–¢æ•°ã¯ Promise ã‚’è¿”ã—ã€ãã®ä¸­ã«ã€ŒæˆåŠŸæ™‚ã®ãƒ‡ãƒ¼ã‚¿ã€ã¨ã€Œã‚¨ãƒ©ãƒ¼æƒ…å ±ã€ãŒã‚»ãƒƒãƒˆã«ãªã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã£ã¦ã„ã‚‹ã€‚
    //ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®æµã‚Œï¼š
    //å¼•æ•°ï¼ˆname, email, passwordï¼‰ã¯ Supabase Auth ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã•ã‚Œã€Authã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã•ã‚Œã‚‹
    //ç™»éŒ²æˆåŠŸå¾Œã€Supabaseã‹ã‚‰è¿”ã£ã¦ããŸ data.userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼‰ã‚’åŠ å·¥ã—ã¦å‘¼ã³å‡ºã—å…ƒã«è¿”ã—ã¦ã„ã‚‹
    //ãã®ãŸã‚ã€å‘¼ã³å‡ºã—å…ƒã§ã¯ç™»éŒ²ç›´å¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»name ãªã©ãŒã™ãä½¿ãˆã‚‹
    async signUp(name: string, email: string, password: string) {
        const {data, error} = await supabase.auth.signUp({
            email,
            password,
            options: {data: {name},},
        });

        //ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        //ã‚¨ãƒ©ãƒ¼ãŒnullã§ãªã„ã€ã¾ãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒnullã§ã‚ã‚‹å ´åˆã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
        //throwã¯ ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        //å‘¼ã³å‡ºã—å…ƒã«ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ â†’ å‘¼ã³å‡ºã—ã‚‚ã¨ã§ã‚¨ãƒ©ãƒ¼ã‚’try-catchã—ã¦å‡¦ç†ã™ã‚‹
        //new Error(error?.message)â‡’ã“ã®æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå‘¼ã³å‡ºã—å…ƒã®catchãƒ–ãƒ­ãƒƒã‚¯ã«eã¨ã—ã¦æ¸¡ã•ã‚Œã‚‹
        if (error !== null || data.user === null) {
            throw new Error(error?.message);
        }

        //data.user ã¯ Supabase ã® signUp() ãŒè¿”ã™ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        //data.user ã«ã¯ SupabaseãŒæ–°è¦ç™»éŒ²æ™‚ã«ä½œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¦ã€
        // ãã®ä¸­ã«ã€Œæ¸¡ã—ãŸ emailã€ã¨ã€Œæ¸¡ã—ãŸ nameï¼ˆmetadataçµŒç”±ï¼‰ã€ã¯å…¥ã£ã¦ã„ã¾ã™ãŒã€password ã¯å«ã¾ã‚Œã¦ã„ãªã„ã€‚
        //å®Ÿéš›ã® data.user ã®ä¾‹
        // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ç›´å¾Œã® data.user ã¯ä¾‹ãˆã°ã“ã‚“ãªå½¢ã«ãªã‚Šã¾ã™ğŸ‘‡
        // {
        //   id: "uuid-xxxx",                       // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
        //   email: "test@example.com",              // â† æ¸¡ã—ãŸ email
        //   user_metadata: { name: "Taro" },        // â† æ¸¡ã—ãŸ name
        //   created_at: "2025-08-10T12:34:56Z",    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ—¥æ™‚(ä»Šå›ã¯æ¸¡ã—ã¦ã„ãªã„ã®ã§å…¥ã£ã¦ã„ãªã„)
        //   ãƒ»
        //   ãƒ»
        //   ãƒ»
        // }

        //...data.user â†’ å…ƒã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å±•é–‹ã—ã¦ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ®‹ã™
        // userName â†’ user_metadata.name ã®å€¤ã‚’ç›´æ¥å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã€æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¨ã—ã¦è¿½åŠ 
        return {
            ...data.user,
            userName:data.user.user_metadata.name,
        }
    },

    //ãƒ­ã‚°ã‚¤ãƒ³
    //signInWithPassword() ã¯ Auth ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç›´æ¥SELECTã™ã‚‹ã®ã§ã¯ãªãã€
    //Supabase Auth ã‚µãƒ¼ãƒãƒ¼ã«ã€Œã“ã®ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã„ã‹ã€ã‚’å•ã„åˆã‚ã›ã€
    // æˆåŠŸã™ã‚Œã° data.user ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼‹data.session ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã—ã¾ã™ã€‚
    async signIn(email: string, password:string) {
        const {data, error} = await supabase.auth.signInWithPassword({
            email,
            password,
        });

        //ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒãƒ¥ã‚¤ãƒ‹ãƒ³ã‚°æ¼”ç®—å­?.â‡’ å·¦å´ (error) ãŒ null ã¾ãŸã¯ undefined ã®å ´åˆ â†’ undefined ã‚’è¿”ã™
        //å·¦å´ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ â†’ ãã®ä¸­ã® message ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿”ã™
        if (error !== null || data.user === null) {
          throw new Error(error?.message);
        }
        
        return {
          ...data.user,
          userName:data.user.user_metadata.name,
        }
    }
}


/*
ãƒ»ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
function divide(a: number, b: number) {
  if (b === 0) {
    throw new Error("0ã§å‰²ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“");
  }
  return a / b;
}

try {
  console.log(divide(10, 0));
} catch (e) {
  console.error("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:", e);
}
b ãŒ 0 ã®ã¨ãã« throw ã§ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿ

try å†…ã®å‡¦ç†ã¯ãã“ã§ä¸­æ–­ã•ã‚Œã€catch ã«å‡¦ç†ãŒç§»ã‚‹
*/

//éåŒæœŸå‡¦ç†ã¨SPA
//SPAãªã‚‰æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚‚ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã¯é€²ã‚€ã€‚
// ãŸã ã—ã€ç™»éŒ²å¾Œã«è¡Œã†ãƒ•ãƒ­ãƒ³ãƒˆå´ã®å‡¦ç†ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
// ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ãŒä¼´ã†å ´åˆã¯é€”ä¸­ã§ä¸­æ–­ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚


/*
signUp() ã®è¿”ã‚Šå€¤ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ (signInWithPassword() ã§ã¯sessionã‚‚è¿”ã‚‹ãŒåŸºæœ¬çš„ãªæ§‹é€ ã¯åŒã˜)

1. æˆåŠŸæ™‚

{
  "data": {
    "user": { "id": "uuid-xxxx", "email": "test@example.com" },
    "session": null
  },
  "error": null
}

data.user â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆnull ã§ã¯ãªã„ï¼‰
error â†’ null

2. å¤±æ•—æ™‚

{
  "data": {
    "user": null,
    "session": null
  },
  "error": {
    "message": "User already registered",
    "status": 400
  }
}

data.user â†’ null
error â†’ ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

*/